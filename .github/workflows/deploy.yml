name: Auto Deploy Taska

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            cd ${{ secrets.SERVER_PATH }}
            echo "üë§ Deploy user: $USER"
            echo "üìÅ Server path: ${{ secrets.SERVER_PATH }}"
            
            # –ò–°–ü–†–ê–í–õ–Ø–ï–ú –ü–†–ê–í–ê –ù–ê –í–°–Æ –ü–ê–ü–ö–£ –ü–†–û–ï–ö–¢–ê
            echo "üîß Fixing ownership of entire project directory to deploy user ($USER)..."
            # –ú–µ–Ω—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤—Å–µ–π –ø–∞–ø–∫–∏ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–µ–ø–ª–æ—è
            sudo chown -R $USER:$USER ${{ secrets.SERVER_PATH }} || true
            # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏ –≤–ª–∞–¥–µ–ª—å—Ü—É
            sudo chmod -R u+rwX ${{ secrets.SERVER_PATH }} || true
            # Git –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω–∞
            if [ -d "${{ secrets.SERVER_PATH }}/.git" ]; then
              sudo chown -R $USER:$USER ${{ secrets.SERVER_PATH }}/.git || true
              sudo chmod -R u+rwX ${{ secrets.SERVER_PATH }}/.git || true
            fi
            echo "‚úÖ Ownership fixed for: ${{ secrets.SERVER_PATH }}"
            
            # Fix Git ownership issue
            git config --global --add safe.directory ${{ secrets.SERVER_PATH }} || true
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            echo "üì• Fetching latest code..."
            git fetch origin
            git reset --hard origin/main
            
            # –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–Ω–æ–≤–∞ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ git —Å–æ–∑–¥–∞–ª —Ñ–∞–π–ª—ã –ø–æ–¥ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º)
            echo "üîß Fixing ownership after git update..."
            sudo chown -R $USER:$USER ${{ secrets.SERVER_PATH }} || true
            
            # Deploy frontend
            echo "üöÄ Deploying frontend..."
            npm ci
            npm run build
            
            # Deploy Telegram bot
            echo "ü§ñ Deploying Telegram bot..."
            if [ -d "telegram-bot" ]; then
              cd telegram-bot
              echo "üìÅ Current directory: $(pwd)"
              echo "üë§ Current user: $(whoami)"
              echo "üîß Fixing ownership of bot files to deploy user..."
              # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª—ã –±–æ—Ç–∞ - –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–µ–ø–ª–æ—è
              sudo chown -R $USER:$USER "$(pwd)" || true
              # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ .env —Ñ–∞–π–ª –¥–æ—Å—Ç—É–ø–µ–Ω
              if [ -f ".env" ]; then
                sudo chown $USER:$USER .env || true
                chmod 600 .env || true
              fi
              # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ firebase-credentials.json –¥–æ—Å—Ç—É–ø–µ–Ω (–µ—Å–ª–∏ –µ—Å—Ç—å)
              if [ -f "firebase-credentials.json" ]; then
                sudo chown $USER:$USER firebase-credentials.json || true
                chmod 600 firebase-credentials.json || true
              fi
              echo "üìù Bot files updated via git, now installing dependencies and restarting service..."
              chmod +x deploy.sh
              # –ó–∞–ø—É—Å–∫–∞–µ–º —Å sudo –¥–ª—è systemd –æ–ø–µ—Ä–∞—Ü–∏–π, –Ω–æ –ø–µ—Ä–µ–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–µ–ø–ª–æ—è
              # –ö–æ–¥ —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ git reset --hard origin/main –≤—ã—à–µ
              DEPLOY_USER=$USER sudo -E ./deploy.sh || echo "‚ö†Ô∏è Telegram bot deployment failed, but continuing..."
              cd ..
            else
              echo "‚ö†Ô∏è Telegram bot directory not found, skipping..."
            fi
            
            # Reload nginx
            echo "üîÑ Reloading nginx..."
            nginx -t
            systemctl reload nginx
            
            echo "‚úÖ Deployment completed!"	
