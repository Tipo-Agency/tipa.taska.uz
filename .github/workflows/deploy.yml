name: Auto Deploy Taska

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            cd ${{ secrets.SERVER_PATH }}
            echo "üë§ Deploy user: $USER"
            echo "üìÅ Server path: ${{ secrets.SERVER_PATH }}"
            
            # –ò–°–ü–†–ê–í–õ–Ø–ï–ú –ü–†–ê–í–ê –ù–ê –í–°–Æ –ü–ê–ü–ö–£ –ü–†–û–ï–ö–¢–ê
            echo "üîß Fixing ownership of entire project directory to deploy user ($USER)..."
            # –ú–µ–Ω—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤—Å–µ–π –ø–∞–ø–∫–∏ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–µ–ø–ª–æ—è
            sudo chown -R $USER:$USER ${{ secrets.SERVER_PATH }} || true
            # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏ –≤–ª–∞–¥–µ–ª—å—Ü—É
            sudo chmod -R u+rwX ${{ secrets.SERVER_PATH }} || true
            # Git –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω–∞
            if [ -d "${{ secrets.SERVER_PATH }}/.git" ]; then
              sudo chown -R $USER:$USER ${{ secrets.SERVER_PATH }}/.git || true
              sudo chmod -R u+rwX ${{ secrets.SERVER_PATH }}/.git || true
            fi
            echo "‚úÖ Ownership fixed for: ${{ secrets.SERVER_PATH }}"
            
            # Fix Git ownership issue
            git config --global --add safe.directory ${{ secrets.SERVER_PATH }} || true
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            echo "üì• Fetching latest code..."
            git fetch origin
            git reset --hard origin/main
            
            # –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–Ω–æ–≤–∞ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ git —Å–æ–∑–¥–∞–ª —Ñ–∞–π–ª—ã –ø–æ–¥ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º)
            echo "üîß Fixing ownership after git update..."
            sudo chown -R $USER:$USER ${{ secrets.SERVER_PATH }} || true
            
            # Deploy frontend
            echo "üöÄ Deploying frontend..."
            npm ci
            npm run build
            
            # Deploy Telegram bot
            echo "ü§ñ Deploying Telegram bot..."
            if [ -d "telegram-bot" ]; then
              cd telegram-bot
              echo "üìÅ Current directory: $(pwd)"
              echo "üë§ Current user: $(whoami)"
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é –∫–æ–¥–∞ (–∫–æ–¥ —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ git reset –≤—ã—à–µ)
              echo "üîç Checking bot code version..."
              CODE_VERSION=$(grep -o "CODE_VERSION_AT_START = \"[^\"]*\"" bot.py 2>/dev/null | head -1 | cut -d'"' -f2 || echo "NOT FOUND")
              if [ "$CODE_VERSION" = "NOT FOUND" ]; then
                # –ü—Ä–æ–±—É–µ–º –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç
                CODE_VERSION=$(grep -o "CODE_VERSION.*=.*\"[^\"]*\"" bot.py 2>/dev/null | head -1 | cut -d'"' -f2 || echo "NOT FOUND")
              fi
              echo "üìã Bot code version in file: $CODE_VERSION"
              
              echo "üîß Fixing ownership of bot files to deploy user..."
              # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª—ã –±–æ—Ç–∞ - –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–µ–ø–ª–æ—è
              sudo chown -R $USER:$USER "$(pwd)" || true
              sudo chmod -R u+rwX "$(pwd)" || true
              
              # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º .env —Ñ–∞–π–ª —Å —Ç–æ–∫–µ–Ω–æ–º –∏–∑ secrets
              echo "üîê Setting up .env file with token from GitHub Secrets..."
              if [ ! -f ".env" ]; then
                echo "   Creating .env file..."
                touch .env
              fi
              
              # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –≤ .env (–¥–æ–±–∞–≤–ª—è–µ–º –∏–ª–∏ –∑–∞–º–µ–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)
              if grep -q "^TELEGRAM_BOT_TOKEN=" .env; then
                # –ó–∞–º–µ–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–∫–µ–Ω
                sed -i "s|^TELEGRAM_BOT_TOKEN=.*|TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}|" .env
                echo "   ‚úÖ Updated TELEGRAM_BOT_TOKEN in .env"
              else
                # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
                echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" >> .env
                echo "   ‚úÖ Added TELEGRAM_BOT_TOKEN to .env"
              fi
              
              # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ .env —Ñ–∞–π–ª –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É
              sudo chown $USER:$USER .env || true
              chmod 600 .env || true
              
              # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ firebase-credentials.json –¥–æ—Å—Ç—É–ø–µ–Ω (–µ—Å–ª–∏ –µ—Å—Ç—å)
              if [ -f "firebase-credentials.json" ]; then
                sudo chown $USER:$USER firebase-credentials.json || true
                chmod 600 firebase-credentials.json || true
              fi
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª bot.py —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —á–∏—Ç–∞–µ—Ç—Å—è
              if [ -f "bot.py" ]; then
                echo "‚úÖ bot.py file exists"
                echo "üìä File size: $(wc -l < bot.py) lines"
              else
                echo "‚ùå bot.py file NOT found!"
              fi
              
              echo "üìù Installing dependencies and restarting service..."
              chmod +x deploy.sh
              # –ó–∞–ø—É—Å–∫–∞–µ–º —Å sudo –¥–ª—è systemd –æ–ø–µ—Ä–∞—Ü–∏–π, –Ω–æ –ø–µ—Ä–µ–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–µ–ø–ª–æ—è
              DEPLOY_USER=$USER sudo -E ./deploy.sh || echo "‚ö†Ô∏è Telegram bot deployment failed, but continuing..."
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
              sleep 3
              if systemctl is-active --quiet telegram-bot; then
                echo "‚úÖ Telegram bot is running"
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –≤–µ—Ä—Å–∏–∏
                echo "üìã Checking bot logs for version..."
                sudo journalctl -u telegram-bot -n 5 --no-pager | grep -i "code version" || echo "‚ö†Ô∏è Version not found in logs (may need to check manually)"
              else
                echo "‚ùå Telegram bot is NOT running!"
                echo "üìã Recent logs:"
                sudo journalctl -u telegram-bot -n 20 --no-pager || true
              fi
              
              cd ..
            else
              echo "‚ö†Ô∏è Telegram bot directory not found, skipping..."
            fi
            
            # Reload nginx
            echo "üîÑ Reloading nginx..."
            nginx -t
            systemctl reload nginx
            
            echo "‚úÖ Deployment completed!"	
