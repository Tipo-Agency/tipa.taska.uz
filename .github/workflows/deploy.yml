name: Auto Deploy Taska

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            cd ${{ secrets.SERVER_PATH }}
            echo "ðŸ‘¤ Deploy user: $USER"
            echo "ðŸ“ Server path: ${{ secrets.SERVER_PATH }}"
            
            # Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð¯Ð•Ðœ ÐŸÐ ÐÐ’Ð ÐÐ Ð’Ð¡Ð® ÐŸÐÐŸÐšÐ£ ÐŸÐ ÐžÐ•ÐšÐ¢Ð
            echo "ðŸ”§ Fixing ownership of entire project directory to deploy user ($USER)..."
            # ÐœÐµÐ½ÑÐµÐ¼ Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†Ð° Ð²ÑÐµÐ¹ Ð¿Ð°Ð¿ÐºÐ¸ Ð½Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ
            sudo chown -R $USER:$USER ${{ secrets.SERVER_PATH }} || true
            # Ð£Ð±ÐµÐ¶Ð´Ð°ÐµÐ¼ÑÑ, Ñ‡Ñ‚Ð¾ Ð²ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹ Ð´Ð»Ñ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ/Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†Ñƒ
            sudo chmod -R u+rwX ${{ secrets.SERVER_PATH }} || true
            # Git Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°
            if [ -d "${{ secrets.SERVER_PATH }}/.git" ]; then
              sudo chown -R $USER:$USER ${{ secrets.SERVER_PATH }}/.git || true
              sudo chmod -R u+rwX ${{ secrets.SERVER_PATH }}/.git || true
            fi
            echo "âœ… Ownership fixed for: ${{ secrets.SERVER_PATH }}"
            
            # Fix Git ownership issue
            git config --global --add safe.directory ${{ secrets.SERVER_PATH }} || true
            
            # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´
            echo "ðŸ“¥ Fetching latest code..."
            git fetch origin
            git reset --hard origin/main
            
            # ÐŸÐ¾ÑÐ»Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ½Ð¾Ð²Ð° Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° (Ð½Ð° ÑÐ»ÑƒÑ‡Ð°Ð¹ ÐµÑÐ»Ð¸ git ÑÐ¾Ð·Ð´Ð°Ð» Ñ„Ð°Ð¹Ð»Ñ‹ Ð¿Ð¾Ð´ Ð´Ñ€ÑƒÐ³Ð¸Ð¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼)
            echo "ðŸ”§ Fixing ownership after git update..."
            sudo chown -R $USER:$USER ${{ secrets.SERVER_PATH }} || true
            
            # Deploy frontend
            echo "ðŸš€ Deploying frontend..."
            npm ci
            npm run build
            
            # Deploy Telegram bot
            echo "ðŸ¤– Deploying Telegram bot..."
            if [ -d "telegram-bot" ]; then
              cd telegram-bot
              echo "ðŸ“ Current directory: $(pwd)"
              echo "ðŸ‘¤ Current user: $(whoami)"
              
              # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ ÐºÐ¾Ð´Ð° (ÐºÐ¾Ð´ ÑƒÐ¶Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½ Ñ‡ÐµÑ€ÐµÐ· git reset Ð²Ñ‹ÑˆÐµ)
              echo "ðŸ” Checking bot code version..."
              CODE_VERSION=$(grep -o "CODE_VERSION_AT_START = \"[^\"]*\"" bot.py 2>/dev/null | head -1 | cut -d'"' -f2 || echo "NOT FOUND")
              if [ "$CODE_VERSION" = "NOT FOUND" ]; then
                # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð´Ñ€ÑƒÐ³Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚
                CODE_VERSION=$(grep -o "CODE_VERSION.*=.*\"[^\"]*\"" bot.py 2>/dev/null | head -1 | cut -d'"' -f2 || echo "NOT FOUND")
              fi
              echo "ðŸ“‹ Bot code version in file: $CODE_VERSION"
              
              echo "ðŸ”§ Fixing ownership of bot files to deploy user..."
              # Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ñ„Ð°Ð¹Ð»Ñ‹ Ð±Ð¾Ñ‚Ð° - Ð¾Ð½Ð¸ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð¿Ñ€Ð¸Ð½Ð°Ð´Ð»ÐµÐ¶Ð°Ñ‚ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ Ð´ÐµÐ¿Ð»Ð¾Ñ
              sudo chown -R $USER:$USER "$(pwd)" || true
              sudo chmod -R u+rwX "$(pwd)" || true
              
              # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ñ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð¼ Ð¸Ð· secrets
              echo "ðŸ” Setting up .env file with token from GitHub Secrets..."
              if [ ! -f ".env" ]; then
                echo "   Creating .env file..."
                touch .env
              fi
              
              # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½ Ð² .env (Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð»Ð¸ Ð·Ð°Ð¼ÐµÐ½ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹)
              if grep -q "^TELEGRAM_BOT_TOKEN=" .env; then
                # Ð—Ð°Ð¼ÐµÐ½ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ñ‚Ð¾ÐºÐµÐ½
                sed -i "s|^TELEGRAM_BOT_TOKEN=.*|TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}|" .env
                echo "   âœ… Updated TELEGRAM_BOT_TOKEN in .env"
              else
                # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½
                echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" >> .env
                echo "   âœ… Added TELEGRAM_BOT_TOKEN to .env"
              fi
              
              # Ð£Ð±ÐµÐ¶Ð´Ð°ÐµÐ¼ÑÑ, Ñ‡Ñ‚Ð¾ .env Ñ„Ð°Ð¹Ð» Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†Ñƒ
              sudo chown $USER:$USER .env || true
              chmod 600 .env || true
              
              # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸Ñ Ñ EnvironmentFile
              echo "ðŸ”§ Updating systemd service with EnvironmentFile..."
              if [ -f "telegram-bot.service" ]; then
                echo "   Copying telegram-bot.service to /etc/systemd/system/..."
                sudo cp telegram-bot.service /etc/systemd/system/telegram-bot.service
                sudo chmod 644 /etc/systemd/system/telegram-bot.service
                echo "   âœ… Systemd service updated"
                echo "   Reloading systemd daemon..."
                sudo systemctl daemon-reload
                echo "   âœ… Systemd daemon reloaded"
              else
                echo "   âš ï¸ telegram-bot.service file not found in bot directory"
                echo "   Creating systemd service manually..."
                sudo tee /etc/systemd/system/telegram-bot.service > /dev/null <<EOF
[Unit]
Description=Telegram Bot for Task Management System
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/var/www/tipa.taska.uz/telegram-bot
Environment="PATH=/var/www/tipa.taska.uz/telegram-bot/venv/bin:/usr/local/bin:/usr/bin:/bin"
EnvironmentFile=/var/www/tipa.taska.uz/telegram-bot/.env
ExecStart=/var/www/tipa.taska.uz/telegram-bot/venv/bin/python /var/www/tipa.taska.uz/telegram-bot/bot.py
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF
                sudo chmod 644 /etc/systemd/system/telegram-bot.service
                sudo systemctl daemon-reload
                echo "   âœ… Systemd service created and reloaded"
              fi
              
              # Ð£Ð±ÐµÐ¶Ð´Ð°ÐµÐ¼ÑÑ, Ñ‡Ñ‚Ð¾ firebase-credentials.json Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
              if [ -f "firebase-credentials.json" ]; then
                sudo chown $USER:$USER firebase-credentials.json || true
                chmod 600 firebase-credentials.json || true
              fi
              
              # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ð» bot.py ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð¸ Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ÑÑ
              if [ -f "bot.py" ]; then
                echo "âœ… bot.py file exists"
                echo "ðŸ“Š File size: $(wc -l < bot.py) lines"
              else
                echo "âŒ bot.py file NOT found!"
              fi
              
              echo "ðŸ“ Installing dependencies and restarting service..."
              chmod +x deploy.sh
              # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ sudo Ð´Ð»Ñ systemd Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹, Ð½Ð¾ Ð¿ÐµÑ€ÐµÐ´Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ
              DEPLOY_USER=$USER sudo -E ./deploy.sh || echo "âš ï¸ Telegram bot deployment failed, but continuing..."
              
              # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐµÑ€Ð²Ð¸Ñ Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ .env Ð¸ systemd
              echo "ðŸ”„ Restarting telegram-bot service..."
              sudo systemctl restart telegram-bot.service || echo "âš ï¸ Failed to restart service"
              sleep 5
              
              # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð±Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»ÑÑ
              if systemctl is-active --quiet telegram-bot; then
                echo "âœ… Telegram bot is running"
                # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾Ð³Ð¸ Ð½Ð° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸
                echo "ðŸ“‹ Checking bot logs for version..."
                sudo journalctl -u telegram-bot -n 5 --no-pager | grep -i "code version" || echo "âš ï¸ Version not found in logs (may need to check manually)"
                # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð½ÐµÑ‚ Ð¾ÑˆÐ¸Ð±Ð¾Ðº 409
                echo "ðŸ“‹ Checking for 409 Conflict errors..."
                if sudo journalctl -u telegram-bot -n 20 --no-pager | grep -qi "409\|conflict"; then
                  echo "   âš ï¸ Found 409/Conflict errors in logs!"
                  sudo journalctl -u telegram-bot -n 20 --no-pager | grep -i "409\|conflict" | tail -3
                else
                  echo "   âœ… No 409/Conflict errors found"
                fi
              else
                echo "âŒ Telegram bot is NOT running!"
                echo "ðŸ“‹ Recent logs:"
                sudo journalctl -u telegram-bot -n 20 --no-pager || true
              fi
              
              cd ..
            else
              echo "âš ï¸ Telegram bot directory not found, skipping..."
            fi
            
            # Reload nginx
            echo "ðŸ”„ Reloading nginx..."
            nginx -t
            systemctl reload nginx
            
            echo "âœ… Deployment completed!"	
