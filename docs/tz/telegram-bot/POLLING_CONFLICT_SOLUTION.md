# Решение проблемы конфликта 409 при использовании Telegram API

## Проблема

Ошибка `409 Conflict: terminated by other getUpdates request` возникает, когда несколько клиентов пытаются использовать `getUpdates` для одного токена бота.

Telegram API позволяет только **одному клиенту** получать обновления через `getUpdates` для одного токена.

## Архитектура решения

### ✅ Что работает БЕЗ конфликта:

1. **Отправка сообщений (sendMessage)** - можно делать из любого места:
   - Отправка в личный чат пользователя
   - Отправка в группу
   - Отправка из фронтенда
   - Отправка из бота на сервере
   - **Все это работает одновременно без конфликта!**

2. **Получение обновлений (getUpdates/polling)** - может быть только одно:
   - Либо бот на сервере использует polling
   - Либо фронтенд использует polling
   - **НЕ оба одновременно для одного токена!**

## Текущая архитектура

### Employee Bot (бот на сервере)
- **Токен**: `TELEGRAM_BOT_TOKEN` из `.env` (через GitHub Secrets)
- **Использование**: 
  - ✅ Polling на сервере (`application.run_polling()`)
  - ✅ Отправка уведомлений в личный чат
  - ✅ Отправка уведомлений в группу
  - ✅ Взаимодействие с пользователями (команды, кнопки)

### Client Bot (для лидов, опционально)
- **Токен**: Отдельный токен (если нужен)
- **Использование**:
  - ✅ Polling на фронтенде (только если токен отличается от employee токена)
  - ✅ Получение лидов из Telegram
  - ✅ Получение сообщений от клиентов

## Решение конфликта

### Вариант 1: Один бот (текущий подход) ✅

**Используйте только Employee Bot:**
- Бот на сервере получает все обновления через polling
- Фронтенд НЕ делает polling (отключен в коде)
- Фронтенд может отправлять сообщения через `sendMessage` (без конфликта)
- Для получения лидов - бот на сервере может отправлять данные в систему

**Преимущества:**
- Простота
- Нет конфликтов
- Один токен

**Недостатки:**
- Лиды из Telegram нужно получать через бота на сервере

### Вариант 2: Два бота (если нужны лиды из Telegram)

**Используйте два разных бота:**

1. **Employee Bot** (текущий):
   - Токен: `8348357222:AAHzzrWFOE7n3MiGYKgugqXbUSehTW1-D1c`
   - Использование: уведомления, взаимодействие с сотрудниками
   - Polling: на сервере

2. **Client Bot** (новый):
   - Токен: другой токен (создать в @BotFather)
   - Использование: получение лидов из Telegram
   - Polling: на фронтенде (если нужно)

**Настройка:**
1. Создайте нового бота в @BotFather
2. Получите токен
3. Установите в настройках системы как "Client Bot Token"
4. Polling на фронтенде автоматически включится

## Текущая реализация

### Код автоматически отключает polling если:

1. Employee токен установлен (значит бот на сервере использует polling)
2. Клиентский токен не установлен
3. Токены совпадают

### Проверки в коде:

**`frontend/hooks/useAppLogic.ts`:**
```typescript
// Если employee токен установлен - polling полностью отключен
if (employeeBotToken) {
  return; // Не создаем interval
}
```

**`services/telegramService.ts`:**
```typescript
// Если токены совпадают - не делаем getUpdates
if (!botToken || botToken === employeeBotToken) {
  return result; // Без вызова API
}
```

## Рекомендации

### Для текущей задачи (бот + уведомления в группу):

✅ **Используйте один бот:**
- Бот на сервере получает команды от пользователей
- Бот на сервере отправляет уведомления в личный чат
- Фронтенд отправляет уведомления в группу через `sendMessage`
- **Все работает без конфликта!**

### Если нужны лиды из Telegram:

1. **Вариант A**: Бот на сервере получает лиды и сохраняет в систему
2. **Вариант B**: Создайте отдельного клиентского бота для лидов

## Проверка

После деплоя проверьте в консоли браузера:
- Должно быть: `[TELEGRAM] ⚠️ Polling ПОЛНОСТЬЮ отключен: employee бот использует polling на сервере`
- Если видите это сообщение - конфликт устранен!

## Важно

- **Отправка сообщений НЕ вызывает конфликт** - можно отправлять из любого места
- **Только getUpdates/polling вызывает конфликт** - может быть только одно место
- **Один бот может отправлять и в личный чат, и в группу** - без проблем
